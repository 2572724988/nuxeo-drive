<html>
<head>
<link rel="stylesheet" href="css/bootstrap.min.css" media="screen">
<link rel="stylesheet" href="css/ndrive.css">
<style type="text/css">
.list-group-item:hover .glyphicon-folder-close:before {
  content: "\e118" !important;
}
</style>
<script src="js/angular.min.js"></script>
<script>
app = angular.module("DriveSystray", []);
app.controller("DriveSystrayCtl", function($scope, $interval) {
	$scope.advanced_systray = function() {
		drive.advanced_systray();
	}
	$scope.interval = null;
	$scope.engines = angular.fromJson(drive.get_engines());
	$scope.engine = null;
	$scope.current_actions = [];
	$scope.last_files = [];	
	$scope.updateFiles = function() {
		if ($scope.current_actions.length < 5) {
			$scope.last_files = angular.fromJson(drive.get_last_files($scope.engine.uid, 5-$scope.current_actions.length, "remote")); 
		} else {
			$scope.last_files = [];	
		}
	}
	$scope.update = function() {
		$scope.sync = drive.is_syncing($scope.engine.uid);
		if ($scope.sync == $scope.engine.syncing && $scope.sync != 'syncing') {
			// Nothing to update
			return;
		}
		$scope.engine.syncing = $scope.sync;
		if ($scope.engine.syncing == 'syncing') {
			$scope.current_actions = angular.fromJson(drive.get_actions($scope.engine.uid));
		} else {
			$scope.current_actions = [];
		}
		$scope.updateFiles();
	}
	$scope.setEngine = function(engine) {
		$scope.engine = engine;
		$scope.sync = drive.is_syncing($scope.engine.uid);
		$scope.current_actions = angular.fromJson(drive.get_actions(engine.uid));
		$scope.updateFiles();
		if ($scope.interval == null) {
			$scope.interval = $interval($scope.update, 1000);
		}
	}
	if ($scope.engines.length > 0) {
		$scope.bind = true;
		$scope.setEngine($scope.engines[0]);
	} else {
		$scope.bind = false;
		drive.resize(300, 225);
	}
	$scope.open_remote = function() {
		drive.open_remote($scope.engine.uid);
	}	
	$scope.open_local = function(path) {
		drive.open_local($scope.engine.uid, path);
	}
	$scope.show_settings = drive.show_settings;
	$scope.quit = drive.quit;
});
</script>
</head>
<body style="overflow: hidden; cursor: default;" ng-app="DriveSystray" ng-controller="DriveSystrayCtl">
<div ng-show="!bind">
<div align="center" style="padding: 20px;">
<p><img alt="Brand" src="imgs/nuxeo_logo.png"></p>
<p>Nuxeo Drive allow you to sync files ...</p>
<p>But first please enter your credentials</p>
<div style="margin-top: 50px;">
<button type="button" class="btn btn-default btn-primary" ng-click="show_settings()">Settings</button>
<button type="button" style="float: right" class="btn btn-default btn-danger" ng-click="quit()">Quit</button>
</div>
</div>
</div>
<div ng-show="bind">
<div class="navbar navbar-fixed-top" style="padding: 10px; min-height: 40px;border-bottom: 1px solid #17384e; background-color: #dfdfdf;">
  <div>{{ engine.username }}<span class="glyphicon glyphicon-option-vertical" style="float:right; margin-left: 20px;" ng-click="advanced_systray()"></span><img style="float:right;margin-right: 4px;" title="{{ engine.name }}" ng-click="setEngine(engine)" src="imgs/{{ engine.type }}.png" ng-repeat="engine in engines" ng-show="engines.length > 1"/></div>
 </div>
<div class="navbar navbar-fixed-bottom" style="padding: 10px; height: 40px; min-height: 40px; border-top: 1px solid #17384e;background-color: #dfdfdf;">
  <div align="right" ng-show="engine.syncing != 'syncing'">
  	Synchronization completed&nbsp;<span class="glyphicon glyphicon-ok">&nbsp;</span>
  </div>
  <div align="right" ng-show="engine.syncing == 'syncing'">
  	Synchronization in progress<span ng-show="engine.queue.total_size > 0">&nbsp;({{engine.queue.total_size}})</span>&nbsp;<img src="imgs/transferring.gif" /></span>
  </div>
</div>
<div class="list-group" style="margin-top: 40px; margin-bottom: 0px;">
  <a class="list-group-item" ng-click="open_local('/')"><span class="glyphicon glyphicon-folder-close">&nbsp;</span>Open Nuxeo Drive Folder</a>
  <a style="border-bottom: 1px solid #17384e;" class="list-group-item" ng-click="open_remote()"><span class="glyphicon glyphicon-globe">&nbsp;</span>Open Nuxeo Server</a>
</div>
<div class="list-group" style="height: 230px; margin-bottom: 40px; overflow: auto;">
  <li class="list-group-item" ng-repeat="action in current_actions">
  {{ action.type }} {{ action.filename }}
  <div class="progress" style="height: 10px; margin-bottom: 5px;">
  <div class="progress-bar progress-bar-info progress-bar-striped active" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"  ng-style="{width : ( action.percent + '%' ) }">
    <span class="sr-only">{{action.percent}}% Complete</span>
  </div>
</div></li>
  <a class="list-group-item" ng-repeat="state in last_files" ng-click="open_local(state.local_path)">{{ state.name }}</a>
</div>
</div>
</body>
</html>