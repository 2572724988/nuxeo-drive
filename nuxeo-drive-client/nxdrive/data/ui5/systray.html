<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="css/bootstrap.min.css" media="screen">
<link rel="stylesheet" href="css/ndrive.css">
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','http://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-81135-23', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
<style type="text/css">
.list-group-item:hover .glyphicon-folder-close:before {
  content: "\e118" !important;
}
.engine-navbar {
	margin: 0;
	list-style: none;
	float: right;
	padding: 0px;
}
.engine-navbar > li {
	display: block;
	position: relative;
	float: left;
	margin-top: -10px;
	margin-bottom: 0px;
	height: 40px;
	padding-left: 5px;
	padding-right: 5px;
}
.engine-navbar > li:hover {
	background-color: #ccc;
	border-bottom: 1px solid #17384e;
}
.currentEngine:hover {
	border-bottom: 0px solid #17384e !important;
}
.currentEngine {
	background-color: #ccc;
	border-left: 1px solid #17384e;
	border-right: 1px solid #17384e;
}
.engine-navbar > li > a {
	padding: 10px 5px;
	display: block;
	line-height: 20px;
}
.notification {
	width: 100%;
	height: 20px;
	padding-top: 4px;
	cursor: pointer;
}
.notification-info {
	background-color: #d9edf7;
	border-top: 1px solid #31708f;
	color:#31708f; 
}
.notification-warning {
	background-color: #fcf8e3;
	border-top: 1px solid #8a6d3b;
	color:#8a6d3b; 
}
.notification-danger {
	background-color: #f2dede;
	border-top: 1px solid #a94442;
	color:#a94442; 
}
</style>
<script src="js/angular.min.js"></script>
<script src="js/angular-translate.min.js"></script>
<script src="i18n.js"></script>
<script>
app = angular.module("DriveSystray", ['pascalprecht.translate']);
app.config(function ($translateProvider) {
	languages = angular.fromJson(drive.get_languages());
	for (i=0; i<languages.length; i++) {
		$translateProvider.translations(languages[i][0], eval("LABELS." + languages[i][0]));
	}
	$translateProvider.preferredLanguage(drive.locale());
});
app.controller("DriveSystrayCtl", function($scope, $interval, $translate) {
	$scope.advanced_systray = function() {
		drive.advanced_systray();
	}
	$scope.interval = null;
	$scope.autoUpdate = drive.get_auto_update();
	$scope.setAutoUpdate = drive.set_auto_update;
	$scope.engines = angular.fromJson(drive.get_engines());
	$scope.appUpdate = function() {
		drive.app_update($scope.confirmAppUpdateDialog);
		$scope.confirmAppUpdateDialog = null;
	}
	$scope.app_update = angular.fromJson(drive.get_update_status());
	$scope.confirmAppUpdateDialog = null;
	$scope.confirmAppUpdate = function (version) {
		$scope.confirmAppUpdateDialog = version;	
	}
	$scope.engine = null;
	$scope.current_actions = [];
	$scope.last_files = [];
	$scope.syncing_items = 0;
	$scope.updateFiles = function() {
		if ($scope.current_actions.length < 5) {
			$scope.last_files = angular.fromJson(drive.get_last_files($scope.engine.uid, 5-$scope.current_actions.length, "remote")); 
		} else {
			$scope.last_files = [];	
		}
	}
	$scope.update = function() {
		$scope.app_update = angular.fromJson(drive.get_update_status());
		$scope.sync = drive.is_syncing($scope.engine.uid);
		if ($scope.sync == $scope.engine.syncing && $scope.sync != 'syncing') {
			// Nothing to update
			return;
		}
		$scope.engine.syncing = $scope.sync;
		if ($scope.engine.syncing == 'syncing') {
			$scope.syncing_items = drive.get_syncing_items($scope.engine.uid);
			$scope.current_actions = angular.fromJson(drive.get_actions($scope.engine.uid));
		} else {
			$scope.syncing_items = 0;
			$scope.current_actions = [];
		}
		$scope.updateFiles();
	}
	$scope.setEngine = function(engine) {
		$scope.engine = engine;
		$scope.sync = drive.is_syncing($scope.engine.uid);
		$scope.current_actions = angular.fromJson(drive.get_actions(engine.uid));
		$scope.updateFiles();
		if ($scope.interval == null) {
			$scope.interval = $interval($scope.update, 1000);
		}
	}
	if ($scope.engines.length > 0) {
		$scope.bind = true;
		$scope.setEngine($scope.engines[0]);
	} else {
		$scope.bind = false;
		drive.resize(300, 225);
	}
	$scope.getEngineClass = function(engine) {
		if (engine == $scope.engine) {
			return "currentEngine";
		}
		return "";
	}
	$scope.open_remote = function() {
		drive.open_remote($scope.engine.uid);
	}	
	$scope.open_local = function(path) {
		drive.open_local($scope.engine.uid, path);
	}
	$scope.show_settings = drive.show_settings;
	$scope.quit = drive.quit;
});
</script>
</head>
<body style="overflow: hidden; cursor: default;" ng-app="DriveSystray" ng-controller="DriveSystrayCtl">
<div ng-show="!bind">
<div align="center" style="padding: 20px;">
<p><img alt="Brand" src="imgs/nuxeo_logo.png"></p>
<p translate>WELCOME_MESSAGE</p>
<div style="margin-top: 50px;">
<button type="button" class="btn btn-default btn-primary" ng-click="show_settings()" translate>SETTINGS</button>
<button type="button" style="float: right" class="btn btn-default btn-danger" ng-click="quit()" translate>QUIT</button>
</div>
</div>
</div>
<div ng-show="bind">
<div class="navbar navbar-fixed-top" style="padding: 10px; min-height: 40px; height: 40px;border-bottom: 1px solid #17384e; background-color: #dfdfdf;">
  <div>
  	<span>{{ engine.username }}</span>
  	<span class="glyphicon glyphicon-option-vertical" style="float:right; margin-left: 20px;" ng-click="advanced_systray()"></span>
  	<ul class="engine-navbar" ng-show="engines.length > 1">
  		<li ng-repeat="engine in engines" ng-class="getEngineClass(engine)">
  		  <a href="#" ng-click="setEngine(engine)">
  			<img title="{{ engine.name }}" src="imgs/{{ engine.type }}.png"/>
  		  </a>
  		</li>
  	</ul>
  </div>
  <div style="position: absolute; top: 29px;">
  	<span ng-click="showConflicts()" ng-show="engine.metrics.conflicted_files > 0" class="label label-warning" translate translate-values="engine.metrics">CONFLICTS_SYSTRAY</span>
  	<span ng-click="showConflicts()" ng-show="engine.metrics.error_files > 0" class="label label-danger" translate translate-values="engine.metrics">ERRORS_SYSTRAY</span>
  </div>
 </div>
<div class="navbar navbar-fixed-bottom" style="padding: 10px; height: 40px; min-height: 40px; border-top: 1px solid #17384e;background-color: #dfdfdf;">
  <div class="label notifications-container" style="position: absolute; padding:0px; left:0px; width: 100%; bottom: 40px; width: 100%;">
	<div ng-show="confirmAppUpdateDialog != null" class="notification-info" style="padding: 10px; padding-bottom: 0px; height: 65px;">
	<span translate translate_values="{ version:confirmAppUpdateDialog }">CONFIRM_UPDATE_MESSAGE</span>
	<form>
	  <div class="row">
	  	<div class="col-xs-2" style="padding-top: 20px;">
		<span ng-click="confirmAppUpdate(null)" class="glyphicon glyphicon-remove-sign alert-danger pull-left" style="font-size: 20px;background: none;">&nbsp;</span>
		</div>
		<div class="checkbox col-xs-8" style="padding-top: 10px;">
	      <input type="checkbox" style="margin-top: -3px" ng-model="autoUpdate" ng-click="setAutoUpdate(autoUpdate)"><span translate>AUTOUPDATE</span>
	  	</div>
	  	<div class="col-xs-2" style="padding-top: 20px;">
		<span ng-click="appUpdate()" class="col-xs-4 glyphicon glyphicon-ok-sign alert-success pull-right" style="font-size: 20px;background: none;">&nbsp;</span>
		</div>
	   </div>
	  </form>
	</div>
  	<div ng-show="app_update[0] == 'update_available' && confirmAppUpdateDialog == null" ng-click="confirmAppUpdate(app_update[1])" class="notification notification-info" translate translate_values="{ version:app_update[1] }">UPGRADE_AVAILABLE</div>
  	<div ng-show="app_update[0] == 'downgrade_needed' && confirmAppUpdateDialog == null" ng-click="confirmAppUpdate(app_update[1])" class="notification notification-danger" translate translate_values="{ version:app_update[1] }">DOWNGRADE_NEEDED</div>
  	<div ng-show="app_update[0] == 'upgrade_needed' && confirmAppUpdateDialog == null" ng-click="confirmAppUpdate(app_update[1])" class="notification notification-danger" translate translate_values="{ version:app_update[1] }">UPGRADE_NEEDED</div>
  	<div ng-show="app_update[0] == 'updating'" class="notification notification-info">
  		<span translate translate_values="{ version:app_update[1] }">UPDATING_VERSION</span>
	  	<div class="progress" style="height: 4px;">
		  <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="{{ app_update[2] }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ app_update[2] }}%">
		    
		  </div>
		</div>
  	</div>
  </div>
  <div align="right" ng-show="engine.syncing != 'syncing'">
  	<span translate>SYNCHRONIZATION_COMPLETED</span>&nbsp;<span class="glyphicon glyphicon-ok">&nbsp;</span>
  </div>
  <div align="right" ng-show="engine.syncing == 'syncing'">
  	<span translate>SYNCHRONIZATION_IN_PROGRESS</span><span ng-show="engine.queue.total_queue > 0">&nbsp;({{engine.queue.total_queue}})</span>&nbsp;<img src="imgs/transferring.gif" /></span>
  </div>
</div>
<div class="list-group" style="margin-top: 40px; margin-bottom: 0px;">
  <a class="list-group-item" ng-click="open_local('/')"><span class="glyphicon glyphicon-folder-close">&nbsp;</span><span translate>OPEN_ROOT_FOLDER</span></a>
  <a style="border-bottom: 1px solid #B5C0C6;" class="list-group-item" ng-click="open_remote()"><span class="glyphicon glyphicon-globe">&nbsp;</span><span translate>OPEN_SERVER</span></a>
</div>
<div class="list-group" style="height: 230px; margin-bottom: 40px; overflow: auto;">
  <li class="list-group-item" ng-repeat="action in current_actions">
  {{ action.type }} {{ action.filename }}
  <div class="progress" style="height: 10px; margin-bottom: 5px;">
  <div class="progress-bar progress-bar-info progress-bar-striped active" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"  ng-style="{width : ( action.percent + '%' ) }">
    <span class="sr-only">{{action.percent}}% Complete</span>
  </div>
</div></li>
  <a class="list-group-item" ng-repeat="state in last_files" ng-click="open_local(state.local_path)">{{ state.name }}</a>
</div>
</div>
</body>
</html>