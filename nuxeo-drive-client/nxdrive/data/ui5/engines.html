<html>
<head>
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/bootstrap-theme.css">
<link rel="stylesheet" href="css/ndrive.css">
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-81135-23', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
<script src="js/angular.min.js"></script>
<script src="js/jquery-2.1.3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script>
if (typeof(drive) != "undefined") {
	drive.resize(1200,715);
}
app = angular.module("DriveDebug", []);
app.controller("DriveDebugCtl", function($scope, $interval) {
	$scope.engines = angular.fromJson(drive.get_engines());
	$scope.engine = null;
	$scope.metrics = null;
	$scope.metrics_name = null;
	$scope.current_actions = [];
	$scope.last_files = [];	
	$scope.updateFiles = function() {
		if ($scope.current_actions.length < 5) {
			$scope.last_files = angular.fromJson(drive.get_last_files($scope.engine.uid, 5-$scope.current_actions.length, "remote")); 
		} else {
			$scope.last_files = [];	
		}
	}
	$scope.setMetrics = function(name, metrics) {
		$scope.metrics_name = name;
		$scope.metrics = metrics;
	}
	$scope.pause = function(type) {
		if ( type == 'engine') {
			if ($scope.is_paused(type)) {
				drive.resume_engine($scope.uid);
			} else {
				drive.suspend_engine($scope.uid);
			}
		} else if ( type == 'local_watcher' ) {
			if ($scope.is_paused(type)) {
				drive.resume_local_watcher($scope.uid);
			} else {
				drive.suspend_local_watcher($scope.uid);
			}
		} else if ( type == 'remote_watcher' ) {
			if ($scope.is_paused(type)) {
				drive.resume_remote_watcher($scope.uid);
			} else {
				drive.suspend_remote_watcher($scope.uid);
			}
		} else {
			// Consider it is a queue
			if ($scope.is_paused(type)) {
				console.log("RESUME QUEUE " + $scope.uid + " " + type)
				drive.resume_queue($scope.uid, type);
			} else {
				drive.suspend_queue($scope.uid, type);
			}
		}
		$scope.update();
	}
	$scope.pause_class = function(type) {
		if ($scope.is_paused(type)) {
			return "glyphicon-play";
		} else {
			return "glyphicon-pause";
		}
	}
	$scope.is_paused = function(type) {
		if (type == "engine") {
			return $scope.engine.paused || !$scope.engine.started;
		} else if (type == "local_watcher") {
			return $scope.engine.local_watcher.paused || !$scope.engine.local_watcher.started;
		} else if (type == "remote_watcher") {
			return $scope.engine.remote_watcher.paused || !$scope.engine.remote_watcher.started;
		} else if (type == "local_folder_queue") {
			return !$scope.engine.queue.local_folder_enable
		} else if (type == "local_file_queue") {
			return !$scope.engine.queue.local_file_enable
		} else if (type == "remote_folder_queue") {
			return !$scope.engine.queue.remote_folder_enable
		} else if (type == "remote_file_queue") {
			return !$scope.engine.queue.remote_file_enable
		}
		return true;
	}
	$scope.update = function() {
		$scope.engine = angular.fromJson(drive.get_engine($scope.uid));
	}
	$scope.setEngine = function(engine) {
		$scope.uid = engine.uid;
		$scope.update();
		$scope.setMetrics('Engine', $scope.engine.metrics);
		if ($scope.interval == null) {
			$scope.interval = $interval($scope.update, 1000);
		}
	}
	if ($scope.engines.length > 0) {
		$scope.setEngine($scope.engines[0]);
	}
})
</script>
</head>
<body ng-app="DriveDebug" ng-controller="DriveDebugCtl">
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
  	<div class="navbar-header">
  	  <a class="navbar-brand" href="#">
        <img alt="Brand" src="imgs/nuxeo_logo.png" height="20">
        Debug
      </a>
    </div>
    <ul class="nav navbar-nav">
    	<li ng-show="!is_paused('engine')"><a href="#" ng-click="pause('engine')"><span class="glyphicon glyphicon-pause" aria-hidden="true"></span>&nbsp;Pause</a></li>
    	<li ng-show="is_paused('engine')"><a href="#" ng-click="pause('engine')"><span class="glyphicon glyphicon-play" aria-hidden="true"></span>&nbsp;Resume</a></li>
    </ul>
  	<ul class="nav navbar-nav navbar-right">
  		<li><a href="#" ng-click="pause('local_watcher')"><span ng-class="pause_class('local_watcher')" class="glyphicon" aria-hidden="true"></span>&nbsp;Local Watcher</a></li>
  		<li><a href="#" ng-click="pause('remote_watcher')"><span ng-class="pause_class('remote_watcher')" class="glyphicon" aria-hidden="true"></span>&nbsp;Remote Watcher</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><b>{{ engine.name }}</b><span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li ng-repeat="engine in engines" ng-click="setEngine(engine)"><a href="#">{{ engine.name }}</a></li>
          </ul>
        </li>
      </ul>
  </div>
</nav>
<div class="container-fluid" style="padding-top: 80px;">
	<div class="row">
		<div class="col-xs-3">
		<table class="table table-hover">
			<thead>
				<tr>
					<th><a href="#" ng-click="pause('local_folder_queue')"><span ng-class="pause_class('local_folder_queue')" class="glyphicon" aria-hidden="true"></span>&nbsp;Local Folders</a><span class="badge pull-right">{{ engine.queue.local_folder_queue }}</span></th>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="item in engine.queue.local_folder">
					<td>{{ item.name }}</td>
				</tr>
			</tbody>
		</table>
		</div>
		<div class="col-xs-3">
		<table class="table table-hover">
			<thead>
				<tr>
					<th><a href="#" ng-click="pause('local_file_queue')"><span ng-class="pause_class('local_file_queue')" class="glyphicon" aria-hidden="true"></span>&nbsp;Local Files</a><span class="badge pull-right">{{ engine.queue.local_file_queue }}</span></th>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="item in engine.queue.local_file">
					<td>{{ item.name }}</td>
				</tr>
			</tbody>
		</table>
		</div>
		<div class="col-xs-3">
		<table class="table table-hover">
			<thead>
				<tr>
					<th><a href="#" ng-click="pause('remote_folder_queue')"><span ng-class="pause_class('remote_folder_queue')" class="glyphicon" aria-hidden="true"></span>&nbsp;Remote Folders</a><span class="badge pull-right">{{ engine.queue.remote_folder_queue }}</span></th>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="item in engine.queue.remote_folder">
					<td>{{ item.name }}</td>
				</tr>
			</tbody>
		</table>
		</div>
		<div class="col-xs-3">
		<table class="table table-hover">
			<thead>
				<tr>
					<th><a href="#" ng-click="pause('remote_file_queue')"><span ng-class="pause_class('remote_file_queue')" class="glyphicon" aria-hidden="true"></span>&nbsp;Remote Files</a><span class="badge pull-right">{{ engine.queue.remote_file_queue }}</span></th>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="item in engine.queue.remote_file">
					<td>{{ item.name }}</td>
				</tr>
			</tbody>
		</table>
		</div>
	</div>
	<div class="row">
		<div class="col-xs-6">
		<table class="table table-hover">
			<thead>
				<tr>
					<th><a href="#" ng-click="refreshLogs()"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>&nbsp;Logs</a></th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>line of logss.....</td>
				</tr>
			</tbody>
		</table>
		</div>
		<div class="col-xs-6">
		<table class="table table-hover">
			<thead>
				<tr>
					<th>
						<ul style="margin-bottom: 0px; padding-left: 0px;"><li style="list-style-type: none;" class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><span class="glyphicon glyphicon-equalizer">&nbsp;</span>Metrics {{ metrics_name }}<span class="caret"></span></a>
			          <ul class="dropdown-menu" role="menu">
			            <li><a href="#" ng-click="setMetrics('QueueManager', engine.queue.metrics)">QueueManager</a></li>
			            <li><a href="#" ng-click="setMetrics('Engine', engine.metrics)">Engine</a></li>
			            <li ng-repeat="thread in engine.threads"><a href="#" ng-click="setMetrics(thread.name, thread.metrics)">{{ thread.name }}</a></li>
			          </ul></li>
			          </ul>
          			</th>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="(key, value) in metrics">
					<td>{{ key }}: {{ value }}</td>
				</tr>
			</tbody>
		</table>
		</div>
	</div>
</div>
</body>
</html>